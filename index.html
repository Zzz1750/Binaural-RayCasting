<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        #name-form {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <div id="name-form">
        <label for="username">Enter Your Name:</label>
        <input type="text" id="username" required>
        <button style="color: black;" onclick="startVR()">Submit</button>
    </div>

    <a-scene id="vr-scene" vr-mode-ui="enabled: true">
        
        <!-- Controllers -->
        <a-entity id="right-hand" laser-controls="hand: right" 
            raycaster="objects: .clickable; showLine: true; interval: 100; color: yellow;">
        </a-entity>

        <a-entity id="head-rig" camera position="0 1.6 0"
            raycaster="objects: .gaze-plane; showLine: false; interval: 100">
        </a-entity>

        <!-- Audio Elements -->
        <audio id="intro-audio" src="./audio/intro.wav" preload="auto"></audio>
        <audio id="mosaic_tiles_audio" src="./audio/mosaic_tiles.wav" preload="auto"></audio>
        <audio id="wood_carvings_audio" src="./audio/wood_carvings.wav" preload="auto"></audio>

        <!-- Scenes -->
        <a-entity id="intro-scene" visible="false">
            <a-sky src="./images/intro.jpg"></a-sky>
            <a-plane id="scene1-button" position="0 1.5 -1" width="1" height="0.5" 
                     color="white" visible="false" class="clickable"
                     text="value: Scene 1; align: center; width: 5; color: black;">
            </a-plane>
        </a-entity>

        <!-- Scene 1 -->
        <a-entity id="scene-1" visible="false">
            <a-sky src="./images/1.png"></a-sky>
            <a-plane id="main_entrance" class="gaze-plane" position="0 1.5 -4" 
                     width="2" height="2" color="blue" visible="false"></a-plane>
            <a-plane id="roof_sculpture" class="gaze-plane" position="2 1.5 -4" 
                     width="2" height="2" color="green" visible="false"></a-plane>
            <a-plane id="scene2-button" position="0 -1 -2" width="1" height="0.5" 
                     color="red" visible="false" class="clickable"
                     text="value: To Scene 2; align: center; color: white;">
            </a-plane>
        </a-entity>

        <!-- Scene 2 -->
        <a-entity id="scene-2" visible="false">
            <a-sky src="./images/2.png"></a-sky>
            <a-plane id="mosaic_tiles" class="gaze-plane" position="-2 1.5 -4" 
                     width="2" height="2" color="purple" visible="false"></a-plane>
            <a-plane id="wood_carvings" class="gaze-plane" position="2 1.5 -4" 
                     width="2" height="2" color="orange" visible="false"></a-plane>
            <a-plane id="finish-button" position="0 -1 -2" width="1" height="0.5" 
                     color="blue" visible="false" class="clickable"
                     text="value: Finish; align: center; color: white;">
            </a-plane>
        </a-entity>

    </a-scene>

<script>
    // DOM Elements
    const sceneEl = document.getElementById("vr-scene");
    const introScene = document.getElementById("intro-scene");
    const scene1 = document.getElementById("scene-1");
    const scene2 = document.getElementById("scene-2");
    
    // Buttons
    const scene1Button = document.getElementById("scene1-button");
    const scene2Button = document.getElementById("scene2-button");
    const finishButton = document.getElementById("finish-button");

    // Scene 1 Elements
    const mainEntrancePlane = document.getElementById("main_entrance");
    const roofSculpturePlane = document.getElementById("roof_sculpture");

    // Scene 2 Elements
    const mosaicTilesPlane = document.getElementById("mosaic_tiles");
    const woodCarvingPlane = document.getElementById("wood_carvings");

    // Audio Elements
    const introAudio = document.getElementById("intro-audio");
    const mosaicTilesAudio = document.getElementById("mosaic_tiles_audio");
    const woodCarvingAudio = document.getElementById("wood_carvings_audio");

    // Tracking Data
    let gazeData = {};
    let audioStartTimes = {};
    let currentGazeStart = null;
    let currentPlane = null;

    function startVR() {
        const name = document.getElementById("username").value.trim();
        if (!name) return alert("Please enter your name");
        
        document.getElementById("name-form").style.display = "none";
        initializeIntroScene();
    }

    function initializeIntroScene() {
        introScene.setAttribute("visible", true);
        introAudio.play();
        
        sceneEl.hasLoaded ? sceneEl.enterVR() : sceneEl.addEventListener("loaded", () => sceneEl.enterVR());
        
        setTimeout(() => {
            scene1Button.setAttribute("visible", true);
            scene1Button.classList.add("clickable");
        }, 24000);
    }

    // Scene Transitions
    function goToScene1() {
        introScene.setAttribute("visible", false);
        scene1.setAttribute("visible", true);
        
        // Initialize Scene 1
        [mainEntrancePlane, roofSculpturePlane].forEach(plane => 
            plane.setAttribute("visible", true));
        
        // Scene 1 Audio Sequence
        audioStartTimes.main_entrance = performance.now();
        setTimeout(() => audioStartTimes.roof_sculpture = performance.now(), 63000);
        
        // Show Scene 2 button after 103s
        setTimeout(() => scene2Button.setAttribute("visible", true), 103000);
    }

    function goToScene2() {
        // Cleanup Scene 1
        scene1.setAttribute("visible", false);
        scene2Button.classList.remove("clickable");
        
        // Initialize Scene 2
        scene2.setAttribute("visible", true);
        [mosaicTilesPlane, woodCarvingPlane].forEach(plane => 
            plane.setAttribute("visible", true));
        
        // Scene 2 Audio Sequence
        setTimeout(() => {
            mosaicTilesAudio.play();
            audioStartTimes.mosaic_tiles = performance.now();
        }, 3000);

        setTimeout(() => {
            woodCarvingAudio.play();
            audioStartTimes.wood_carvings = performance.now();
        }, 56000);

        // Show Finish button after 100s
        setTimeout(() => finishButton.setAttribute("visible", true), 100000);
    }

    // Gaze Tracking System
    document.getElementById("head-rig").addEventListener("raycaster-intersection", e => {
        const plane = e.detail.els[0];
        if (!plane?.getAttribute("visible")) return;

        currentGazeStart = performance.now();
        currentPlane = plane.id;

        if (audioStartTimes[currentPlane] && !gazeData[currentPlane]?.reaction) {
            gazeData[currentPlane].reaction = 
                (performance.now() - audioStartTimes[currentPlane]) / 1000;
        }
    });

    document.getElementById("head-rig").addEventListener("raycaster-intersection-cleared", () => {
        if (!currentGazeStart) return;

        const duration = (performance.now() - currentGazeStart) / 1000;
        const data = gazeData[currentPlane];

        data.total += duration;
        data.longest = Math.max(data.longest, duration);
        
        currentGazeStart = null;
        updateGazeDisplay();
    });

    function updateGazeDisplay() {
        const displayText = Object.entries(gazeData).map(([name, data]) => 
            `${name.replace(/_/g, ' ').toUpperCase()}:\n` +
            `Total: ${data.total.toFixed(1)}s\n` +
            `Longest: ${data.longest.toFixed(1)}s\n` +
            `Reaction: ${data.reaction?.toFixed(1) || 'N/A'}s`
        ).join('\n\n');

        document.getElementById("gaze-data-display").setAttribute("text", `value: ${displayText}`);
    }

    // Event Listeners
    scene1Button.addEventListener("click", goToScene1);
    scene2Button.addEventListener("click", goToScene2);
    finishButton.addEventListener("click", () => console.log("Finish button clicked"));

    // Initialize Data Structures
    function resetGazeData() {
        gazeData = {
            mosaic_tiles: { total: 0, longest: 0, reaction: null },
            wood_carvings: { total: 0, longest: 0, reaction: null }
        };
    }
    resetGazeData();

    // Audio Pre-load Handling
    [introAudio, mosaicTilesAudio, woodCarvingAudio].forEach(audio => {
        if (audio.readyState < 3) audio.load();
    });
</script>
</body>
</html>
